<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anime Slayer Clone</title>
<style>
body { font-family: Arial,sans-serif; background:#111; color:#fff; margin:0; padding:0; }
header { padding:20px; text-align:center; background:#222; }
#searchBar { width:60%; padding:10px; border-radius:5px; border:none; margin-bottom:10px; }
#mainBtns { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
button { padding:10px 15px; border:none; border-radius:5px; background:#ff6600; color:#fff; cursor:pointer; transition:0.3s; }
button:hover { background:#ff9933; }
#animeGrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:15px; padding:20px; }
.animeCard { background:#333; border-radius:8px; cursor:pointer; overflow:hidden; transition:0.3s; position:relative; }
.animeCard:hover { transform:scale(1.05); }
.animeCard img { width:100%; height:200px; object-fit:cover; }
.animeTitle { padding:10px; text-align:center; font-weight:bold; }
.favoriteBtn { position:absolute; top:10px; right:10px; font-size:20px; cursor:pointer; color:#fff; }
.favoriteBtn.active { color:red; }
#animeDetails { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); padding:40px; overflow-y:auto; }
#closeBtn { cursor:pointer; font-size:20px; background:#ff6600; border:none; padding:5px 10px; border-radius:5px; color:#fff; margin-bottom:10px; }
#episodeList { display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; }
#episodeList button { padding:5px 10px; background:#ff6600; border:none; border-radius:5px; cursor:pointer; color:#fff; }
video, iframe { width:100%; max-width:600px; margin-top:15px; border-radius:5px; }
#favoritesList { position:fixed; right:0; top:0; width:250px; background:#222; height:100%; overflow-y:auto; padding:10px; display:none; z-index:1000; }
#favoritesList h3 { text-align:center; }
</style>
</head>
<body>
<header>
  <h1>Anime Slayer Clone</h1>
  <input type="text" id="searchBar" placeholder="ابحث عن أنمي...">
  <div id="mainBtns">
    <button onclick="showTopAnime()">أفضل 30 أنمي</button>
    <button onclick="showAllAnime()">كل الأنميات</button>
    <button onclick="showFavorites()">المفضلة ❤️</button>
    <button onclick="showAllGenres()">التصنيفات</button>
  </div>
</header>

<div id="animeGrid"></div>

<div id="animeDetails">
  <button id="closeBtn">رجوع</button>
  <h2 id="detailTitle"></h2>
  <img id="detailCover" src="" alt="" style="width:300px;height:auto;">
  <p id="detailInfo"></p>
  <p id="detailDescription"></p>
  <div id="episodeList"></div>
  <iframe id="episodePlayer" frameborder="0" allowfullscreen></iframe>
</div>

<div id="favoritesList">
  <h3>المفضلة ❤️</h3>
  <div id="favGrid"></div>
</div>

<script>
const grid = document.getElementById("animeGrid");
const searchBar = document.getElementById("searchBar");
const details = document.getElementById("animeDetails");
const closeBtn = document.getElementById("closeBtn");
const detailTitle = document.getElementById("detailTitle");
const detailCover = document.getElementById("detailCover");
const detailDesc = document.getElementById("detailDescription");
const detailInfo = document.getElementById("detailInfo");
const episodeList = document.getElementById("episodeList");
const episodePlayer = document.getElementById("episodePlayer");
const favoritesList = document.getElementById("favoritesList");
const favGrid = document.getElementById("favGrid");

let favorites = [];
let currentAnime = null;

// AniList GraphQL
async function fetchAniList(query){
  const resp = await fetch('https://graphql.anilist.co',{
    method:'POST',
    headers:{ 'Content-Type':'application/json','Accept':'application/json' },
    body: JSON.stringify({ query })
  });
  return await resp.json();
}

// ترجمة دقيقة
async function translateToArabic(text){
  if(!text) return "لا يوجد وصف";
  try{
    const resp = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ar`);
    const data = await resp.json();
    return data.responseData.translatedText;
  }catch{
    return text;
  }
}

// عرض أفضل 30 أنمي
async function showTopAnime(){
  const query = `
    query {
      Page(perPage:30){
        media(type:ANIME, sort:POPULARITY_DESC){
          id title { romaji, english } description(asHtml:false)
          coverImage { large } genres episodes status averageScore studios { nodes { name } }
        }
      }
    }
  `;
  const data = await fetchAniList(query);
  displayAnime(data.data.Page.media);
}

// عرض كل الأنميات (50 لكل صفحة)
async function showAllAnime(){
  const query = `
    query {
      Page(perPage:50){
        media(type:ANIME, sort:POPULARITY_DESC){
          id title { romaji, english } description(asHtml:false)
          coverImage { large } genres episodes status averageScore studios { nodes { name } }
        }
      }
    }
  `;
  const data = await fetchAniList(query);
  displayAnime(data.data.Page.media);
}

// البحث عن أنمي
async function searchAnime(name){
  const query = `
    query {
      Page(perPage:30){
        media(search:"${name}", type:ANIME){
          id title { romaji, english } description(asHtml:false)
          coverImage { large } genres episodes status averageScore studios { nodes { name } }
        }
      }
    }
  `;
  const data = await fetchAniList(query);
  displayAnime(data.data.Page.media);
}

// عرض التصنيفات
function showAllGenres(){
  const genres = ["Action","Comedy","Drama","Fantasy","Horror","Romance","School"];
  grid.innerHTML="";
  genres.forEach(g=>{
    const btn=document.createElement("button");
    btn.textContent=g;
    btn.onclick=()=>searchByGenre(g);
    grid.appendChild(btn);
  });
}

// البحث حسب التصنيف
async function searchByGenre(genre){
  const query = `
    query {
      Page(perPage:30){
        media(type:ANIME, genre:"${genre}"){
          id title { romaji, english } description(asHtml:false)
          coverImage { large } genres episodes status averageScore studios { nodes { name } }
        }
      }
    }
  `;
  const data = await fetchAniList(query);
  displayAnime(data.data.Page.media);
}

// عرض الأنمي
function displayAnime(animes){
  grid.innerHTML="";
  if(!animes || animes.length===0){ grid.innerHTML="<p>لم يتم العثور على أي أنمي.</p>"; return; }
  animes.forEach(async(anime)=>{
    const card=document.createElement("div");
    card.className="animeCard";
    const translatedDesc = await translateToArabic(anime.description);
    card.innerHTML=`
      <img src="${anime.coverImage.large}" alt="${anime.title.romaji}">
      <div class="animeTitle">${anime.title.romaji}</div>
      <span class="favoriteBtn" onclick="toggleFavorite(${anime.id}, event)">♡</span>
    `;
    card.onclick=()=>showDetails({...anime, description:translatedDesc});
    grid.appendChild(card);
  });
}

// عرض تفاصيل الأنمي
function showDetails(anime){
  currentAnime = anime;
  details.style.display="block";
  detailTitle.textContent = anime.title.romaji;
  detailCover.src = anime.coverImage.large;
  detailDesc.textContent = anime.description;
  detailInfo.innerHTML = `الحلقات: ${anime.episodes || "غير معروف"} | الحالة: ${anime.status} | التقييم: ${anime.averageScore || "N/A"} | الاستوديو: ${anime.studios.nodes.map(s=>s.name).join(", ")}`;

  // الحلقات
  episodeList.innerHTML="";
  for(let i=1; i<= (anime.episodes || 1); i++){
    const btn = document.createElement("button");
    btn.textContent = `الحلقة ${i}`;
    btn.onclick = ()=> loadEpisode(anime.id, i);
    episodeList.appendChild(btn);
  }
  // تحميل الحلقة الأولى تلقائياً
  if(anime.episodes) loadEpisode(anime.id, 1);
}

// تحميل حلقة عبر AnimEmbed
function loadEpisode(id, epNum){
  episodePlayer.src = `https://autoembed.to/anime/anilist/${id}/${epNum}`;
  episodePlayer.scrollIntoView({behavior:"smooth"});
}

// زر الرجوع
closeBtn.onclick = () => {
  details.style.display="none";
  episodePlayer.src = "";
};

// البحث عند الضغط Enter
searchBar.addEventListener("keyup",(e)=>{
  if(e.key==="Enter") searchAnime(searchBar.value);
});

// المفضلة
function toggleFavorite(id,e){
  e.stopPropagation();
  const index = favorites.findIndex(a=>a.id===id);
  if(index===-1){
    favorites.push({id});
    e.target.classList.add("active");
  }else{
    favorites.splice(index,1);
    e.target.classList.remove("active");
  }
  updateFavorites();
}

function updateFavorites(){
  favGrid.innerHTML="";
  favorites.forEach(fav=>{
    const div = document.createElement("div");
    div.textContent = `Anime ID: ${fav.id}`;
    favGrid.appendChild(div);
  });
}

function showFavorites(){
  favoritesList.style.display = favoritesList.style.display==="block" ? "none" : "block";
}

// تحميل أفضل 30 عند بداية الصفحة
showTopAnime();
</script>
</body>
</html>